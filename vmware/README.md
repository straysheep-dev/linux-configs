# vmware

Configurations for VMware Workstation

- [Manually Configure Networking](#manually-configure-networking)
- [YubiKey Passthrough](#yubikey-vmware-passthrough)

## Manually Configure Networking

`/etc/vmware/networking`

`/etc/vmware/netmap.conf`

On some installs of VMware Workstation (this has only happened on Ubuntu 20.04, I have not been able to reproduce this on Fedora >=34 or Kali >=2021.4), the networking configuration files are not written during install. This will cause networking to fail until a valid set of configuration files are written. This is easy to miss if for example you're updating VMware Workstation to a new version, as those files will be present unless you removed them.

- [ ] Run `vmware-netcfg` or from the VMware Workstation menu `Edit > Virtual Network Editor`

If it segfaults, check if `/etc/vmware/networking` and `/etc/vmware/netmap.conf` exist.

If they don't exists, write the defaults manually using the templates below.

This configuration is the same as the default you get from a fresh install, only here you're deciding the values of the network adapters. You'll end up with the following:

* A Bridged network adapter
* A NAT network adapter
* A Host-only network adapter

#### /etc/vmware/networking:

```conf
VERSION=1,0
answer VNET_1_DHCP yes
answer VNET_1_DHCP_CFG_HASH <hash>
answer VNET_1_DISPLAY_NAME 
answer VNET_1_HOSTONLY_NETMASK <netmask>
answer VNET_1_HOSTONLY_SUBNET <network-ip-addr>
answer VNET_1_VIRTUAL_ADAPTER yes
answer VNET_8_DHCP yes
answer VNET_8_DHCP_CFG_HASH <hash>
answer VNET_8_DISPLAY_NAME 
answer VNET_8_HOSTONLY_NETMASK <netmask>
answer VNET_8_HOSTONLY_SUBNET <network-ip-addr>
answer VNET_8_NAT yes
answer VNET_8_NAT_PARAM_UDP_TIMEOUT 30
answer VNET_8_VIRTUAL_ADAPTER yes
```

#### /etc/vmware/netmap.conf:

```conf
# This file is automatically generated.
# Hand-editing this file is not recommended.
network0.name = "Bridged"
network0.device = "vmnet0"
network1.name = "HostOnly"
network1.device = "vmnet1"
network8.name = "NAT"
network8.device = "vmnet8"
```

* You can delete the `<hash>` altogether, and VMware will automatically generate the correct value upon starting Workstation.
* `<netmask>` is any valid netmask (ie; 255.255.0.0)
* `<network-ip-addr>` is whatever network address of the subnet you specify. (ie; 172.16.10.0)

Alternatively, you can also import a working network configuration from another existing VMware installation:

<https://docs.vmware.com/en/VMware-Workstation-Pro/16.0/com.vmware.ws.using.doc/GUID-AC956B17-30BA-45F7-9A39-DCCB96B0A713.html>


## YubiKey VMware Passthrough

- Troubleshooting YubiKey device passthrough:
<https://support.yubico.com/hc/en-us/articles/360013647640-Troubleshooting-Device-Passthrough-with-VMware-Workstation-and-VMware-Fusion>

- Editing .vmx files:
<https://kb.vmware.com/s/article/2057902>

1. Disconnect the YubiKey
2. Power off the virtual machine
3. If `VM > Options > Access Control > Encryption` is set, remove encryption temporarily to be able to edit the .vmx configuration file for this machine.
4. **If any of them are missing**, add the following lines anywhere within the configuration file (not at the top, typically add these near any of the other usb configuration lines, or at the very bottom. It will not hurt to ensure all three are present **only once** per config file):

```vmx
usb.generic.allowHID = "TRUE"
usb.generic.allowLastHID = "TRUE"
usb.quirks.device0 = "0x1050:0x0407 allow"
```
4. Save, optionally close and re-open the VMware Workstation application
5. Take a snapshot to preserve your edits to the .vmx file if you use snapshots for this VM
6. Re-encrypt the VM (setting encryption / access control is independant of snapshots).
5. Power on the virtual machine
6. Reconnect the YubiKey
7. The YubiKey should be visible under `VM > Removeable Devices > Yubico.com YubiKey ...`, choose to Connect it (not the `Shared YubiKey ...` if that's listed)
8. Confirm the YubiKey is present within the VM:
```bash
lsusb | grep -i 'yubikey'
gpg --card-status
```

You may also notice some quirks if you do not go to `VM > Removeable Devices > Yubico.com YubiKey ...> Disconnect` before powering off the VM.

If this happens, you can disconnect / reconnect the key from the host. At this point, the host should have control of the key again, and you'll be able to pass it through to any guest configured to accept it.

Generally the fastest way back to a working baseline when troubleshooting key passthrough with drivers is disconnecting the key before reconnecting and choosing to connect it to a VM. In rare cases (specifically where the `yubioath-desktop` [snap package](https://snapcraft.io/yubioath-desktop) for [managing OTP codes stored on a YubiKey](https://github.com/Yubico/yubioath-desktop) and the host's `scdaemon` are attempting to both read the key and you also try to connect it to a VM) you may need to reboot the system.
